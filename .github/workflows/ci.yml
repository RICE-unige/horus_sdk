name: SDK CI

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main
      - feature/sdk-rust-parity
      - feature/sdk-cpp-parity

env:
  PYTHON_VERSION: "3.12"
  ROS_DISTRO: humble

jobs:
  python-tests:
    name: Python Baseline Tests
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup ROS (${{ env.ROS_DISTRO }})
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: ${{ env.ROS_DISTRO }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ROS Python deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ros-${{ env.ROS_DISTRO }}-rclpy \
            ros-${{ env.ROS_DISTRO }}-std-msgs \
            ros-${{ env.ROS_DISTRO }}-sensor-msgs \
            ros-${{ env.ROS_DISTRO }}-nav-msgs \
            ros-${{ env.ROS_DISTRO }}-geometry-msgs \
            ros-${{ env.ROS_DISTRO }}-tf2-ros

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          pip install -e . --no-deps

      - name: Run Python tests
        shell: bash
        run: |
          source /opt/ros/${{ env.ROS_DISTRO }}/setup.bash
          pytest python/tests -q

  cpp-build-test:
    name: C++ Build/Test (${{ matrix.ros_mode }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        ros_mode: ["off", "on"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup ROS (${{ env.ROS_DISTRO }})
        if: matrix.ros_mode == 'on'
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: ${{ env.ROS_DISTRO }}

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Install ROS deps
        if: matrix.ros_mode == 'on'
        run: |
          sudo apt-get install -y \
            ros-${{ env.ROS_DISTRO }}-ament-cmake \
            ros-${{ env.ROS_DISTRO }}-rclcpp \
            ros-${{ env.ROS_DISTRO }}-std-msgs \
            ros-${{ env.ROS_DISTRO }}-sensor-msgs \
            ros-${{ env.ROS_DISTRO }}-nav-msgs \
            ros-${{ env.ROS_DISTRO }}-geometry-msgs

      - name: Configure CMake (no-ROS)
        if: matrix.ros_mode == 'off'
        run: |
          cmake -S cpp -B cpp/build_no_ros -DHORUS_ENABLE_ROS2=OFF

      - name: Configure CMake (ROS enabled)
        if: matrix.ros_mode == 'on'
        shell: bash
        run: |
          source /opt/ros/${{ env.ROS_DISTRO }}/setup.bash
          cmake -S cpp -B cpp/build_with_ros -DHORUS_ENABLE_ROS2=ON

      - name: Build
        run: |
          if [ "${{ matrix.ros_mode }}" = "on" ]; then
            cmake --build cpp/build_with_ros --parallel
          else
            cmake --build cpp/build_no_ros --parallel
          fi

      - name: Run C++ tests
        run: |
          if [ "${{ matrix.ros_mode }}" = "on" ]; then
            ctest --test-dir cpp/build_with_ros --output-on-failure
          else
            ctest --test-dir cpp/build_no_ros --output-on-failure
          fi

      - name: Benchmark smoke
        run: |
          if [ "${{ matrix.ros_mode }}" = "on" ]; then
            ./cpp/build_with_ros/benchmarks/payload_micro
            ./cpp/build_with_ros/benchmarks/registration_scenario
          else
            ./cpp/build_no_ros/benchmarks/payload_micro
            ./cpp/build_no_ros/benchmarks/registration_scenario
          fi
