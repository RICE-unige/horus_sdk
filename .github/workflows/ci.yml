name: CI Pipeline

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main
      - feature/sdk-rust-parity
      - feature/sdk-cpp-parity

env:
  ROS_DISTRO: humble
  PYTHON_VERSION: "3.10"

jobs:
  # Code Quality Checks
  quality:
    name: Code Quality
    runs-on: ubuntu-22.04
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 mypy bandit safety
          pip install -e . --no-deps

      - name: Format check (Black)
        run: black --check --diff python/ || true

      - name: Lint Python code (Flake8)
        run: flake8 python/ --max-line-length=88 --extend-ignore=E203,W503 || true

      - name: Type check (MyPy)
        run: mypy python/horus/ --ignore-missing-imports || true

      - name: Security scan (Bandit)
        run: bandit -r python/horus/ -f json -o bandit-report.json || true

      - name: Dependency vulnerability scan
        run: safety check --json --output safety-report.json || true

      - name: Install C++ tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format cppcheck clang-tidy

      - name: Format check C++ (clang-format)
        run: |
          find cpp/ -name "*.cpp" -o -name "*.hpp" | \
          xargs clang-format --dry-run --Werror || true

      - name: C++ static analysis (cppcheck)
        run: |
          cppcheck --enable=all --inconclusive --xml --xml-version=2 \
          cpp/ 2> cppcheck-report.xml || true
